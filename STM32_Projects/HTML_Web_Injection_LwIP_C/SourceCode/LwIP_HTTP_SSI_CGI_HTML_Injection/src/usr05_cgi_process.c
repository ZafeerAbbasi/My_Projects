/*
# ##############################################################################
# File: usr05_cgi_process.c                                                    #
# Project: src                                                                 #
# Created Date: Friday, October 13th 2023, 3:51:04 am                          #
# Author: Zafeer Abbasi                                                        #
# ----------------------------------------------                               #
# Last Modified: Sunday, October 15th 2023, 6:07:26 pm                         #
# Modified By: Zafeer Abbasi                                                   #
# ----------------------------------------------                               #
# Copyright (c) 2023 Zafeer.A                                                  #
# ----------------------------------------------                               #
# HISTORY:                                                                     #
 */

/*##############################################################################################################################################*/
/*INCLUDES______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/

#include "usr05_cgi_process.h"
#include <string.h>
#include <stdio.h>
#include "lwip/apps/httpd.h"
#include <stdbool.h>

/*##############################################################################################################################################*/
/*FUNCTION DECLARATIONS_________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/



/*##############################################################################################################################################*/
/*GLOBALS_______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/

const tCGI CGI_LED = { "/leds.cgi", CGI_ledCGIHandler };
const tCGI CGI_SLIDER = { "/slider.cgi", CGI_sliderHandler };
tCGI ARR_CGI[ NUM_OF_CGI ];

extern TIM_HandleTypeDef hTimer;

/*##############################################################################################################################################*/
/*DEFINES_______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/



/*##############################################################################################################################################*/
/*TYPEDEFS/STRUCTS/ENUMS________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/



/*##############################################################################################################################################*/
/*FUNCTIONS_____________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/

const char *CGI_ledCGIHandler( int iIndex, int iNumParams, char *pcParam[ ], char *pcValue[ ] )
{
    if( iIndex == 0 )
    {
        LED_deactivateLED( GREEN_LED );
        LED_deactivateLED( BLUE_LED );
        LED_deactivateLED( RED_LED );
    }

    for( int i = 0; i < iNumParams; i++ )
    {
        if( strcmp( pcParam[ i ], "led" ) == 0 )
        {
            if( strcmp( pcValue[ i ], "1" ) == 0 )
            {
                
                LED_toggleLED( RED_LED ); 
            
            }
            else if( strcmp( pcValue[ i ], "2" ) == 0 )
            {

                LED_toggleLED( BLUE_LED );

            }
            else if( strcmp( pcValue[ i ], "3" ) == 0 )
            {
                
                LED_toggleLED( GREEN_LED );
            
            }
        }
    }

    isGreenLedOn = HAL_GPIO_ReadPin( GREEN_LED_PORT, GREEN_LED );
    isBlueLedOn = HAL_GPIO_ReadPin( BLUE_LED_PORT, BLUE_LED );
    isRedLedOn = HAL_GPIO_ReadPin( RED_LED_PORT, RED_LED );

    return "/led_control.shtml";
}


const char *CGI_sliderHandler( int iIndex, int iNumParams, char *pcParam[ ], char *pcValue[ ] )
{
    // Directly process the slider value since we know we only have one parameter
        value = atoi(pcValue[0]);
        //printf("Slider Value: %d\r\n", value );
        int dutyCycle = (hTimer.Init.Period * value ) / 100;
        __HAL_TIM_SET_COMPARE( &hTimer, TIM_CHANNEL_1, dutyCycle );
    return "/led_control.shtml";
}



/*##############################################################################################################################################*/
/*EXTERNS_______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/